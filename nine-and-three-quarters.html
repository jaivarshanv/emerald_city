<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Emerald City: Spellbound | IEEE-CS VIT</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IM+Fell+DW+Pica+SC&family=Pirata+One&display=swap');
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        @media (min-width: 769px) {
            * { cursor: none !important; }
        }

        body { 
            background-color: #010103; margin: 0; 
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center; 
            min-height: 100vh; font-family: 'IM Fell DW Pica SC', serif; 
            overflow: hidden; 
        }
        
        /* PERSISTENT STORM LAYER */
        canvas#storm-canvas { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 5; pointer-events: none; 
        }

        #game-header {
            position: fixed; top: 20px; width: 100%;
            font-family: 'IM Fell DW Pica SC', serif; font-size: clamp(1.5rem, 5vw, 3.5rem); 
            color: #d4af37; text-shadow: 0 0 10px rgba(212, 175, 55, 0.5), 3px 3px 5px #000;
            z-index: 50; display: none; text-align: center;
            letter-spacing: 4px; text-transform: uppercase;
            pointer-events: none;
        }

        /* ELDER WAND */
        #wand-anchor { 
            position: fixed; top: 0; left: 0; pointer-events: none; 
            z-index: 9999; transform-origin: 300px 6px; display: none; align-items: center; 
        }
        @media (min-width: 769px) { #wand-anchor { display: flex; } }
        .wand-body { height: 12px; width: 300px; background: linear-gradient(90deg, #1a0f08, #3d2b1f, #2a1b0e); border-radius: 6px; position: relative; }
        .wand-tip { position: absolute; right: -5px; top: -1px; width: 14px; height: 14px; background: #fff; border-radius: 50%; box-shadow: 0 0 25px 10px #d4af37, 0 0 50px 20px #fff; }

        /* OVERLAYS & CONTAINERS */
        #intro-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.9); z-index: 1000; 
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center; 
            padding: 30px; text-align: center;
        }

        #passage-text { 
            color: #d4af37; font-size: clamp(1.1rem, 3vw, 1.8rem); 
            max-width: 850px; line-height: 1.6; margin-bottom: 40px;
            opacity: 0; transition: opacity 2s;
        }

        .btn-container { display: flex; flex-direction: column; align-items: center; gap: 15px; width: 100%; }
        
        .start-ui-btn, .btn { 
            background: #2a1b0e; color: #f4e4bc; border: 2px solid #d4af37; 
            padding: clamp(12px, 2vh, 20px) 30px; font-family: 'IM Fell DW Pica SC'; 
            font-size: clamp(1.1rem, 4vw, 1.5rem); cursor: pointer !important; transition: 0.3s;
            width: min(90%, 380px); z-index: 1001;
        }
        .start-ui-btn:hover, .btn:hover { background: #3d2b1f; box-shadow: 0 0 15px #d4af37; transform: scale(1.02); }

        /* FEEDBACK CLASSES */
        .correct-glow { 
            background: #004d26 !important; 
            box-shadow: 0 0 30px #50c878 !important; 
            border-color: #50c878 !important;
            color: #fff !important;
        }

        .incorrect-glow { 
            background: #5d0000 !important; 
            box-shadow: 0 0 30px #ff0000 !important; 
            border-color: #ff0000 !important;
            color: #fff !important;
            animation: shake 0.4s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        #envelope-wrapper { display: none; z-index: 50; opacity: 0; transition: opacity 1.5s; cursor: pointer !important; }
        
        #main-container { 
            display: none; width: 95%; max-width: 850px; 
            background: #f4e4bc url('https://www.transparenttextures.com/patterns/paper-fibers.png'); 
            padding: clamp(30px, 8vw, 60px) 20px; border: 4px solid #d4af37; 
            box-shadow: 0 0 100px rgba(0,0,0,1); text-align: center; 
            z-index: 60; position: relative; margin-top: 120px;
        }

        /* SORTING HAT */
        #sorting-hat-img {
            position: absolute; top: -90px; left: 50%; transform: translateX(-50%);
            width: 180px; z-index: 70;
            filter: drop-shadow(0 15px 15px rgba(0,0,0,0.5));
            animation: hatTalk 3s infinite ease-in-out, hatFloat 5s infinite ease-in-out;
        }
        @keyframes hatTalk { 0%, 100% { transform: translateX(-50%) scale(1, 1); } 50% { transform: translateX(-50%) scale(1.05, 0.95); } }
        @keyframes hatFloat { 0%, 100% { margin-top: 0; } 50% { margin-top: -15px; } }

        /* REPLAY & BUBBLE */
        #replay-header { display: flex; align-items: center; gap: 10px; margin-top: 50px; margin-bottom: 20px; }
        #hat-bubble { 
            background: white; padding: 15px; border: 3px solid #3b2a1a; 
            border-radius: 12px; font-weight: bold; color: #5d0000; flex-grow: 1;
            font-size: clamp(0.9rem, 3.5vw, 1.2rem);
        }
        .replay-btn {
            background: #d4af37; color: #1a0f08; border: 2px solid #1a0f08;
            border-radius: 50%; width: 45px; height: 45px; display: flex;
            align-items: center; justify-content: center; cursor: pointer !important;
            font-size: 1.5rem; transition: 0.3s;
        }
        .replay-btn:hover { background: #f4e4bc; transform: rotate(-45deg); }

        #q-text { font-size: clamp(1.2rem, 5vw, 1.8rem); line-height: 1.4; color: #1a0f08; margin-bottom: 25px; }
        .hidden { display: none; }
        .fade-out { opacity: 0 !important; transition: opacity 1s; }

        @media (max-width: 768px) {
            #sorting-hat-img { width: 130px; top: -70px; }
            #main-container { margin-top: 100px; padding-top: 40px; }
        }
    </style>
</head>
<body onclick="startExperience()">

<canvas id="storm-canvas"></canvas>

<div id="intro-overlay">
    <div id="passage-text">
        "Halt traveler. Entry to the Emerald City is earned, not given. Within this letter lies a trial of wit. Prove you know these halls as well as the ghosts that haunt them, or the gates remain shut. Open the seal, answer the Hat, and pray your logic is sharper than his tongue. Mischief Managed."
    </div>
    <div class="btn-container">
        <button class="start-ui-btn" id="hear-btn" onclick="startExperience()">HEAR THE WARNING</button>
        <button class="start-ui-btn" style="border-color: #555; color: #888; font-size: 1.1rem;" onclick="skipToMap()">SKIP TO MAP</button>
    </div>
</div>

<h1 id="game-header">EMERALD CITY : SPELL BOUND</h1>

<audio id="bg-music" loop src="hpt.mp3"></audio>
<audio id="opening-voice" src="opening.mp3"></audio>
<audio id="hat-voice"></audio>
<audio id="thunder-sound" src="thunder.mp3"></audio>

<div id="wand-anchor">
    <div class="wand-body"><div class="wand-tip"></div></div>
</div>

<div id="envelope-wrapper" onclick="openLetter()">
    <div class="btn-container">
        <div style="width: min(90vw, 450px); height: 280px; background: #e4d5b7; position: relative; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 20px; box-shadow: 0 40px 80px #000;">
            <div style="position: absolute; top: 0; width: 0; height: 0; border-left: min(45vw, 225px) solid transparent; border-right: min(45vw, 225px) solid transparent; border-top: 160px solid #d4c3a1;"></div>
            <div style="position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); width: 90px; height: 90px; background: #8b0000; border-radius: 50%; border: 4px solid #3a0000; color: #d4af37; display: flex; align-items: center; justify-content: center; font-family: 'Pirata One'; font-size: 1.2rem;">IEEE-CS</div>
            <p style="color: #5d4a37; font-weight: bold;">OPEN THE SEAL</p>
        </div>
    </div>
</div>

<div id="main-container">
    <img id="sorting-hat-img" src="sorting hat.png" alt="Sorting Hat">
    <div id="quiz-ui">
        <div id="replay-header">
            <div id="hat-bubble">"Prove you are a wizard of VIT, or be gone."</div>
            <button class="replay-btn" onclick="replayAudio()">â†º</button>
        </div>
        <p id="q-text"></p>
        <div id="options" class="btn-container"></div>
    </div>
    <div id="result-ui" class="hidden">
        <h1 style="color: #50c878; text-shadow: 0 0 20px #50c878; font-size: clamp(1.8rem, 6vw, 3rem);">MISCHIEF MANAGED!</h1>
        <p>The Portkey is activating...</p>
    </div>
</div>

<script>
    const questions = [
        { q: "A vast amphitheater where the voices resound... Named for the great leader who mastered the art of the word...", ans: "Anna Auditorium", audio: "annaaudi.mp3", distractors: ["ChannaReddy Auditorium", "CS Hall"] },
        { q: "A silent cathedral of parchment and ink... Guarded by turnstiles that demand a digital key...", ans: "EVR Central Library", audio: "library.mp3", distractors: ["Library", "Study Hall"] },
        { q: "The final boundary where the sentinels stand, between our sanctuary and the Muggle land...", ans: "Main Gate", audio: "maingate.mp3", distractors: ["SJT Back Gate", "Main Tunnel"] },
        { q: "Beneath the hall where champions sweat... lies a subterranean vault hidden from the light.", ans: "All-Mart", audio: "ALLmart.mp3", distractors: ["Enzo", "Foodys"] }
    ];

    const sharpMocks = [
        { text: "Wrong. A Muggle could have guessed better.", file: "brains.mp3" },
        { text: "Incorrect. Perhaps I should have sorted you into the 'Lost and Found'.", file: "lost%20and%20found.mp3" },
        { text: "Pathetic. Try again, or find someone more worthy.", file: "more%20worthy.mp3" },
        { text: "You're clearly out of your league.", file: "out%20of%20your%20league.mp3" }
    ];

    let currentStep = 0;
    let lastMockIndex = -1;
    let magicStarted = false;
    const openingVoice = document.getElementById('opening-voice');
    const wand = document.getElementById('wand-anchor');
    const hatVoice = document.getElementById('hat-voice');
    const thunder = document.getElementById('thunder-sound');

    // Wand Logic
    document.addEventListener('mousemove', (e) => {
        if(window.innerWidth > 768) {
            wand.style.left = (e.clientX - 300) + 'px'; wand.style.top = (e.clientY - 6) + 'px';
            const angle = Math.atan2(e.clientY - window.innerHeight / 2, e.clientX - window.innerWidth / 2);
            wand.style.transform = `rotate(${angle}rad)`;
        }
    });

    function startExperience() {
        if (magicStarted) return;
        magicStarted = true;
        document.getElementById('hear-btn').style.display = 'none';
        document.getElementById('bg-music').volume = 0.25;
        document.getElementById('bg-music').play().catch(()=>{});
        openingVoice.play().catch(()=>{});
        document.getElementById('passage-text').style.opacity = '1';
        openingVoice.onended = transitionToEnvelope;
    }

    function skipToMap() {
        if (magicStarted) openingVoice.pause();
        magicStarted = true;
        document.getElementById('bg-music').play().catch(()=>{});
        transitionToEnvelope();
    }

    function transitionToEnvelope() {
        document.getElementById('intro-overlay').classList.add('fade-out');
        setTimeout(() => {
            document.getElementById('intro-overlay').style.display = 'none';
            document.getElementById('game-header').style.display = 'block';
            document.getElementById('envelope-wrapper').style.display = 'block';
            setTimeout(() => { document.getElementById('envelope-wrapper').style.opacity = '1'; }, 50);
        }, 1000);
    }

    function openLetter() {
        document.getElementById('envelope-wrapper').style.display = 'none';
        document.getElementById('main-container').style.display = 'block';
        showQuestion();
    }

    function replayAudio() {
        hatVoice.pause(); hatVoice.currentTime = 0; hatVoice.play().catch(()=>{});
    }

    function showQuestion() {
        const qData = questions[currentStep];
        document.getElementById('q-text').innerText = qData.q;
        hatVoice.src = qData.audio;
        hatVoice.play().catch(()=>{});
        const optDiv = document.getElementById('options');
        optDiv.innerHTML = '';
        [qData.ans, ...qData.distractors].sort(() => Math.random() - 0.5).forEach(choice => {
            const b = document.createElement('button');
            b.className = 'btn'; b.innerText = choice;
            b.onclick = () => {
                if(choice === qData.ans) {
                    b.classList.add('correct-glow');
                    hatVoice.pause();
                    currentStep++;
                    setTimeout(() => {
                        if(currentStep < questions.length) {
                            document.getElementById('hat-bubble').innerText = '"Correct. Next trial..."';
                            optDiv.innerHTML = '';
                            showQuestion();
                        } else {
                            finishQuiz();
                        }
                    }, 1000);
                } else {
                    b.classList.add('incorrect-glow');
                    setTimeout(() => b.classList.remove('incorrect-glow'), 500);
                    
                    let mockIdx;
                    do { mockIdx = Math.floor(Math.random() * sharpMocks.length); } while (mockIdx === lastMockIndex);
                    lastMockIndex = mockIdx;
                    const mock = sharpMocks[mockIdx];
                    document.getElementById('hat-bubble').innerText = `"${mock.text}"`;
                    hatVoice.src = mock.file; hatVoice.play().catch(()=>{});
                }
            };
            optDiv.appendChild(b);
        });
    }

    function finishQuiz() {
        document.getElementById('quiz-ui').classList.add('hidden');
        document.getElementById('result-ui').classList.remove('hidden');
        setTimeout(() => {
            document.body.style.backgroundColor = '#000';
            document.getElementById('main-container').classList.add('fade-out');
            setTimeout(() => { window.location.href = "https://riviera.vit.ac.in/events/evt_f5838cb6d4de4e469b55ef9910deb062"; }, 2500);
        }, 2000);
    }

    // RAIN ENGINE
    const canvas = document.getElementById('storm-canvas');
    const ctx = canvas.getContext('2d');
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();
    let drops = [];
    for(let i=0; i<120; i++) drops.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height, l: Math.random()*20, v: Math.random()*12+10});
    function draw() {
        ctx.fillStyle = 'rgba(0,0,0,0.2)'; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.strokeStyle = 'rgba(174,194,224,0.3)'; ctx.lineWidth = 1;
        drops.forEach(d => {
            ctx.beginPath(); ctx.moveTo(d.x, d.y); ctx.lineTo(d.x, d.y+d.l); ctx.stroke();
            d.y += d.v; if(d.y > canvas.height) d.y = -20;
        });
        if(Math.random() > 0.97) {
            ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.fillRect(0,0,canvas.width,canvas.height);
            if(magicStarted) { thunder.volume = 0.2; thunder.currentTime = 0; thunder.play().catch(()=>{}); }
        }
        requestAnimationFrame(draw);
    }
    draw();
</script>
</body>
</html>